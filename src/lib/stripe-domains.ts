/**
 * Stripe Domain Management
 * 
 * Handles registering domains with Stripe for Apple Pay verification.
 * When a coach adds a custom domain, we register it with their connected
 * Stripe account to enable Apple Pay on that domain.
 * 
 * Note: Apple Pay requires:
 * 1. Domain to be registered via Stripe API
 * 2. Verification file served at /.well-known/apple-developer-merchantid-domain-association
 */

import Stripe from 'stripe';

// Initialize Stripe with the platform's secret key
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2025-02-24.acacia',
});

interface StripeDomainResult {
  success: boolean;
  domainId?: string;
  error?: string;
}

/**
 * Register a domain for Apple Pay with a connected Stripe account
 * 
 * @param domain - The domain to register (e.g., "cyberked.com")
 * @param stripeConnectAccountId - The connected account's Stripe ID
 * @returns Result with success status
 */
export async function registerDomainForApplePay(
  domain: string,
  stripeConnectAccountId: string
): Promise<StripeDomainResult> {
  try {
    // Register the domain for Apple Pay on the connected account
    const applePayDomain = await stripe.applePayDomains.create(
      { domain_name: domain },
      { stripeAccount: stripeConnectAccountId }
    );
    
    console.log(`[STRIPE_DOMAINS] Registered domain ${domain} for Apple Pay on account ${stripeConnectAccountId} (ID: ${applePayDomain.id})`);
    
    return {
      success: true,
      domainId: applePayDomain.id,
    };
  } catch (error) {
    console.error('[STRIPE_DOMAINS] Error registering domain for Apple Pay:', error);
    
    const errorMessage = error instanceof Error ? error.message : 'Unknown error';
    
    // Handle specific error cases
    if (errorMessage.includes('already been registered')) {
      console.log(`[STRIPE_DOMAINS] Domain ${domain} already registered for Apple Pay`);
      return {
        success: true, // Domain is already registered, which is fine
      };
    }
    
    if (errorMessage.includes('verification failed') || errorMessage.includes('verify')) {
      return {
        success: false,
        error: 'Domain verification failed. Make sure DNS is configured correctly and the verification file is accessible.',
      };
    }
    
    return {
      success: false,
      error: errorMessage,
    };
  }
}

/**
 * Register a domain for Apple Pay with the platform's Stripe account
 * Use this for domains that use the platform's payment processing
 * 
 * @param domain - The domain to register
 * @returns Result with success status
 */
export async function registerDomainForApplePayPlatform(
  domain: string
): Promise<StripeDomainResult> {
  try {
    const applePayDomain = await stripe.applePayDomains.create({
      domain_name: domain,
    });
    
    console.log(`[STRIPE_DOMAINS] Registered domain ${domain} for Apple Pay on platform (ID: ${applePayDomain.id})`);
    
    return {
      success: true,
      domainId: applePayDomain.id,
    };
  } catch (error) {
    console.error('[STRIPE_DOMAINS] Error registering domain for Apple Pay (platform):', error);
    
    const errorMessage = error instanceof Error ? error.message : 'Unknown error';
    
    if (errorMessage.includes('already been registered')) {
      return { success: true };
    }
    
    return {
      success: false,
      error: errorMessage,
    };
  }
}

/**
 * Remove a domain from Apple Pay registration
 * 
 * @param domain - The domain to remove
 * @param stripeConnectAccountId - Optional connected account ID
 */
export async function removeDomainFromApplePay(
  domain: string,
  stripeConnectAccountId?: string
): Promise<StripeDomainResult> {
  try {
    // List domains to find the one to delete
    const options = stripeConnectAccountId 
      ? { stripeAccount: stripeConnectAccountId }
      : undefined;
    
    const domains = await stripe.applePayDomains.list(
      { domain_name: domain },
      options
    );
    
    if (domains.data.length === 0) {
      console.log(`[STRIPE_DOMAINS] Domain ${domain} not found in Apple Pay domains`);
      return { success: true }; // Not found is fine - nothing to delete
    }
    
    // Delete the domain
    for (const applePayDomain of domains.data) {
      await stripe.applePayDomains.del(applePayDomain.id, options);
      console.log(`[STRIPE_DOMAINS] Removed Apple Pay domain ${domain} (ID: ${applePayDomain.id})`);
    }
    
    return { success: true };
  } catch (error) {
    console.error('[STRIPE_DOMAINS] Error removing domain from Apple Pay:', error);
    
    const errorMessage = error instanceof Error ? error.message : 'Unknown error';
    
    // Not found is fine
    if (errorMessage.includes('not found') || errorMessage.includes('No such')) {
      return { success: true };
    }
    
    return {
      success: false,
      error: errorMessage,
    };
  }
}

/**
 * Get the Apple Pay domain verification file content
 * This content needs to be served at /.well-known/apple-developer-merchantid-domain-association
 * 
 * Stripe provides this content and it's the same for all merchants using Stripe.
 * The actual verification happens when Apple's servers fetch this file from the domain.
 */
export function getApplePayVerificationFileContent(): string {
  // This is Stripe's standard Apple Pay domain association file content
  // It's a cryptographic certificate that proves Stripe is the payment processor
  // Source: https://stripe.com/docs/apple-pay/web#get-verified
  return `7B227073704964223A2236354545363135412D444432372D344138342D423830452D3637374235454631364436222C2276657273696F6E223A312C22637265617465644174223A313536333336393931333333302C227369676E6174757265223A22333038303036303932613836343838366637306430313037303261303830333038303032303130313331306633303064303630393630383634383031363530333034303230313035303033303830303630393261383634383836663730643031303730313030303061303830333038323033653333303832303338386130303330323031303230323038346333303431343935313964353436363330306130363038326138363438636533643034303330323330376133313265333032633036303335353034303330633235343137303730366336353230343137303730366336393633363137343639366636653230343936653734363536373732363137343639366636653230343334313230326432303437333333313236333032343036303335353034306230633164343137303730366336353230343336353732373436393636363936333631373436393666366532303431373537343638366637323639373437393331313333303131303630333535303430613063306134313730373036633635323034393665363332653331306233303039303630333535303430363133303235353533333031653137306433313339333033353331333833303331333333323335333735613137306433323334333033353331333633303331333333323335333735613330356633313235333032333036303335353034303330633163363536333633326437333664373032643632373236663662363537323264373336393637366535663535343333343264353035323466343433313134333031323036303335353034306230633062363934663533323035333739373337343635366437333331313333303131303630333535303430613063306134313730373036633635323034393665363332653331306233303039303630333535303430363133303235353533333035393330313330363037326138363438636533643032303130363038326138363438636533643033303130373033343230303034633231353737656465626436633762323231386636386464373039306131323138646337623062643666326332383364383436303935643934616634613534313162383334323065643831316633343037653833333331663163353463336637656233323230643662616435643465666634393238393839336537633066313361333832303231313330383230323064333030633036303335353164313330313031666630343032333030303330316630363033353531643233303431383330313638303134323366323439633434663933653465663237653663346636323836633366613262626664326534623330343530363038326230363031303530353037303130313034333933303337333033353036303832623036303130353035303733303031383632393638373437343730336132663266366636333733373032653631373037303663363532653633366636643266366636333733373033303334326436313730373036633635363136393633363133333330333233303832303131643036303335353164323030343832303131343330383230313130333038323031306330363039326138363438383666373633363430353031333038316665333038316333303630383262303630313035303530373032303233303831623630633831623335323635366336393631366536333635323036663665323037343638363937333230363336353732373436393636363936333631373436353230363237393230363136653739323037303631373237343739323036313733373337353664363537333230363136333633363537303734363136653633363532303666363632303734363836353230373436383635366532303631373037303663363936333631363236633635323037333734363136653634363137323634323037343635373236643733323036313665363432303633366636653634363937343639366636653733323036663636323037353733363532633230363336353732373436393636363936333631373436353230373036663663363936333739323036313665363432303633363537323734363936363639363336313734363936663665323037303732363136333734363936333635323037333734363137343635366436353665373437333265333033363036303832623036303130353035303730323031313632613638373437343730336132663266373737373737326536313730373036633635326536333666366432663633363537323734363936363639363336313734363536313735373436383666373236393734373932663330333430363033353531643166303432643330326233303239613032376130323538363233363837343734373033613266326636333732366332653631373037303663363532653633366636643266363137303730366336353631363936333631333332653633373236633330316430363033353531643065303431363034313439343537646236666435373438313836383938393736326637653537383530376537396235383234333030653036303335353164306630313031666630343034303330323037383033303066303630393261383634383836663736333634303631643034303230353030333030613036303832613836343863653364303430333032303334393030333034363032323130306131363637373965373138656339653466653335363736313832373335393239396639633963366334323666623332613436303663383137313665393934363630323231303062363637653836616137323230366232303730346535643132633962323066626636393933643839666338396335306133656530626361333435303234303633333038323032656533303832303237356130303330323031303230323038343936643266626633613938646139373330306130363038326138363438636533643034303330323330363733313162333031393036303335353034303330633132343137303730366336353230353236663666373432303433343132303264323034373333333132363330323430363033353530343062306331643431373037303663363532303433363537323734363936363639363336313734363936663665323034313735373436383666373236393734373933313133333031313036303335353034306130633061343137303730366336353230343936653633326533313062333030393036303335353034303631333032353535333330316531373064333133393330333333323332333133343334333333393337356131373064333333343330333333323332333133343334333333393337356133303761333132653330326330363033353530343033306332353431373037303663363532303431373037303663363936333631373436393666366532303439366537343635363737323631373436393666366532303433343132303264323034373333333132363330323430363033353530343062306331643431373037303663363532303433363537323734363936363639363336313734363936663665323034313735373436383666373236393734373933313133333031313036303335353034306130633061343137303730366336353230343936653633326533313062333030393036303335353034303631333032353535333330353933303133303630373261383634386365336430323031303630383261383634386365336430333031303730333432303030346630313731313834313964373634383564353161356532353831303737366538383061326566646537626165346465303864666334623933653133333536636436303562303936346130316364643134363862346430326635303162323161353034376331373134393265313464383330613538303765633134346233303766613338316637333038316634333034363036303832623036303130353035303730313031303433613330333833303336303630383262303630313035303530373330303138363261363837343734373033613266326636663633373337303265363137303730366336353265363336663664326636663633373337303330333432643631373037303663363537323666366637343633363136373333333031643036303335353164306530343136303431343233663234396334346639336534656632376536633466363238366333666132626266643265346233303066303630333535316431333031303166663034303533303033303130316666333031663036303335353164323330343138333031363830313462626230646561313538333338383961613438613939646562656264656261666461636232346162333033373036303335353164316630343330333032653330326361303261613032383836323636383734373437303361326632663633373236633265363137303730366336353265363336663664326636313730373036633635373236663666373436333631363733333265363337323663333030653036303335353164306630313031666630343034303330323031303633303130303630613261383634383836663736333634303630323065303430323035303033303061303630383261383634386365336430343033303230333637303033303634303233303361636637323833353131363939623138366662333563333536636136326266663431376564643930663735346461323865626566313963363833393364616136366239333834626233633865363331663931363238313166353330343566303230323330323235333734343361393438313736313364386638366562623065376635383835346365633662333639353461326464356563343365323132313735343739343861343835326436313565613337346339613630373063613062373161643562636533303030333138316163333038316139303230313031303436363330363433303238303231343937633832363665633039323666323639653161396337616239323835613733356635373963613438323038303231343934353764623666643537343831383638393839373632663765353738353037653739623538323430333064303630393630383634383031363530333034303230313035303030343436333034343032323030663838623932656237633462646237656333623634653136356366306139366265336330313333313434323461396630366235356239366335356164626337303232303564643637363166646439626666333034363437383936313932363564353931386433363533653135313433376633306263313433333230336438613830303030303030303030303030227D`;
}

/**
 * Check if Stripe domain verification is configured
 * Requires STRIPE_SECRET_KEY to be set
 */
export function isStripeDomainConfigured(): boolean {
  return !!process.env.STRIPE_SECRET_KEY;
}


