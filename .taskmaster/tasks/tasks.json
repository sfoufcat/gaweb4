{
  "master": {
    "tasks": [
      {
        "id": "60",
        "title": "Create Coaching Chat API Endpoint",
        "description": "Implement a new API endpoint for creating and retrieving coaching chat channels",
        "details": "Create `/api/chat/coaching/route.ts` that accepts a `clientId` parameter and returns existing coaching channel or creates a new one with format `coaching-{orgSuffix}-{userSuffix}`. The endpoint should check if a coaching channel already exists between the coach and client, and if not, create one with proper custom data properties: `isCoachingChat: true`, `organizationId`, `coachId`, `clientId`. Store the `chatChannelId` in the `clientCoachingData` collection for future reference.",
        "testStrategy": "Unit tests for API endpoint with mock data, integration tests to verify channel creation/retrieval, test with existing and non-existing coaching channels",
        "priority": "high",
        "dependencies": [],
        "status": "done",
        "subtasks": [],
        "updatedAt": "2026-01-07T19:15:25.799Z"
      },
      {
        "id": "61",
        "title": "Modify DM API to Check for Existing Coaching Channels",
        "description": "Update the DM channel creation logic to prevent duplicate channels between coaches and clients",
        "details": "Modify `/api/chat/dm/route.ts` to check if one user is an org admin (coach) and the other is a client. Before creating a new DM channel, check if a coaching channel already exists using the coaching API. If a coaching channel exists, return that channel instead of creating a new DM. If one user is a coach, always use/create the coaching channel format instead of the DM format.",
        "testStrategy": "Test scenarios: coach-client DM creation (should use coaching channel), regular user DM creation (should use DM channel), existing coaching channel scenarios",
        "priority": "high",
        "dependencies": [
          "60"
        ],
        "status": "done",
        "subtasks": [],
        "updatedAt": "2026-01-07T19:16:29.093Z"
      },
      {
        "id": "62",
        "title": "Update openOrCreateDirectChat Function",
        "description": "Enhance the chat opening logic to handle coaching context appropriately",
        "details": "Update `openOrCreateDirectChat()` function in `src/lib/chat.ts` to add an `isCoachingContext` parameter. When `isCoachingContext` is true, use the `/api/chat/coaching` endpoint instead of `/api/chat/dm`. This function should determine the context based on user roles and relationship (coach-client vs regular users).",
        "testStrategy": "Test function with coaching context enabled/disabled, verify correct API endpoint usage, test with different user role combinations",
        "priority": "high",
        "dependencies": [
          "60",
          "61"
        ],
        "status": "done",
        "subtasks": [],
        "updatedAt": "2026-01-07T19:17:04.198Z"
      },
      {
        "id": "63",
        "title": "Implement Dynamic Channel Name Display Logic",
        "description": "Create logic to dynamically generate channel display names based on viewer role",
        "details": "Remove static `name` property from coaching channels and implement dynamic naming logic. For coaches viewing coaching channels, display the client's full name. For clients in 1:1 programs, display 'Work with me 1:1' with coach image. For clients not in 1:1 programs, display the coach's name. Create a utility function that takes the channel, current user, and context to return the appropriate display name.",
        "testStrategy": "Test display names for different user roles and program enrollment states, verify coach sees client names and clients see appropriate coach branding",
        "priority": "medium",
        "dependencies": [],
        "status": "done",
        "subtasks": [],
        "updatedAt": "2026-01-07T19:18:36.459Z"
      },
      {
        "id": "64",
        "title": "Fix Channel Tab Filtering Logic",
        "description": "Update the channel list UI to correctly categorize coaching channels into appropriate tabs",
        "details": "Update `StreamChatComponents.tsx` to fix tab filtering logic for coaching channels. For coaches, all coaching channels should appear in the Direct tab. For clients enrolled in 1:1 programs, coaching channels should appear in the Main tab. For clients not enrolled in 1:1 programs but where the coach has messaged them, channels should appear in the Direct tab. Implement logic to check program enrollment status and user roles to determine correct tab placement.",
        "testStrategy": "Test tab placement for coaches (all in Direct), clients with 1:1 enrollment (Main tab), clients without 1:1 enrollment (Direct tab), verify channels don't appear until coach initiates contact for non-enrolled clients",
        "priority": "high",
        "dependencies": [
          "63"
        ],
        "status": "done",
        "subtasks": [],
        "updatedAt": "2026-01-07T19:18:36.460Z"
      },
      {
        "id": "65",
        "title": "Update Profile Message Icon Handler",
        "description": "Modify profile page message icons to use coaching chat consistently",
        "details": "Update `/app/profile/[userId]/page.tsx` to check if the current user is a coach viewing a client profile. If so, use the coaching chat endpoint instead of the regular DM endpoint. Check for existing `coachingChatChannelId` in the `clientCoachingData` collection and use the coaching context when opening chats. Ensure the message icon always opens the same coaching channel that appears in the channel list.",
        "testStrategy": "Test message icon clicks from client profiles as coach, verify same channel opens as in channel list, test with existing and new coaching relationships",
        "priority": "medium",
        "dependencies": [
          "62"
        ],
        "status": "done",
        "subtasks": [],
        "updatedAt": "2026-01-07T19:20:49.122Z"
      },
      {
        "id": "66",
        "title": "Update Client Card Message Icons",
        "description": "Ensure all message icons in coach client management areas use coaching channels",
        "details": "Update message icons in `/app/coach/clients/` components and any client card components to use the coaching chat endpoint. Ensure all message icons throughout the coach interface (client lists, client cards, etc.) consistently open the same coaching channel. Update the `ChatSheet.tsx` component to use coaching channels when opened from client context.",
        "testStrategy": "Test message icons from various coach interface locations (client list, client cards, chat sheet), verify all open the same coaching channel, test consistency across different entry points",
        "priority": "medium",
        "dependencies": [
          "62"
        ],
        "status": "done",
        "subtasks": [],
        "updatedAt": "2026-01-07T19:20:49.123Z"
      },
      {
        "id": "67",
        "title": "Add Coaching Channel Custom Properties",
        "description": "Ensure all coaching channels have the required custom data properties for proper filtering and identification",
        "details": "Update coaching channel creation to include all required custom data properties: `isCoachingChat: true`, `organizationId`, `coachId`, `clientId`, `created_by_id: coachId`. Ensure these properties are consistently set when creating new coaching channels and can be used for filtering and identification throughout the application.",
        "testStrategy": "Verify custom properties are set on new coaching channels, test channel filtering using these properties, validate data integrity across channel operations",
        "priority": "medium",
        "dependencies": [
          "60"
        ],
        "status": "done",
        "subtasks": [],
        "updatedAt": "2026-01-07T19:20:49.123Z"
      },
      {
        "id": "68",
        "title": "Implement Channel Visibility Rules",
        "description": "Create logic to control when coaching channels are visible to clients based on enrollment and coach interaction",
        "details": "Implement visibility rules where coaching chats only appear for clients if they are enrolled in an active 1:1 program (Main tab) or if the coach has initiated contact (Direct tab). For clients not in 1:1 programs, channels should be hidden by default and only appear after the coach sends the first message. Create functions to check program enrollment status and message history to determine visibility.",
        "testStrategy": "Test channel visibility for clients with/without 1:1 enrollment, verify channels appear after coach initiates contact, test hiding channels for clients without coach interaction",
        "priority": "medium",
        "dependencies": [
          "64",
          "67"
        ],
        "status": "done",
        "subtasks": [],
        "updatedAt": "2026-01-07T19:20:49.124Z"
      },
      {
        "id": "69",
        "title": "Create Migration Script for Existing Channels",
        "description": "Develop a migration script to consolidate existing DM channels into coaching channels",
        "details": "Create a migration script that identifies existing DM channels between coaches and clients, checks if corresponding coaching channels exist, and consolidates them. If both DM and coaching channels exist, migrate messages from DM to coaching channel (if Stream Chat API allows) and delete the DM channel. Update existing coaching channels to include missing custom data properties and remove hardcoded name properties.",
        "testStrategy": "Test migration script with sample data, verify message preservation, test rollback procedures, validate data integrity after migration",
        "priority": "low",
        "dependencies": [
          "67"
        ],
        "status": "pending",
        "subtasks": []
      },
      {
        "id": "70",
        "title": "Handle Program Enrollment State Changes",
        "description": "Implement logic to handle coaching channel visibility when clients enroll or unenroll from 1:1 programs",
        "details": "Create event handlers for program enrollment changes that update coaching channel visibility and tab placement. When a client enrolls in a 1:1 program, move their coaching chat to the Main tab with 'Work with me 1:1' branding. When they unenroll, move the chat to the Direct tab and update the display name to show the coach's name. Preserve all chat history during these transitions.",
        "testStrategy": "Test enrollment/unenrollment scenarios, verify channel moves between tabs correctly, test display name updates, ensure chat history is preserved",
        "priority": "medium",
        "dependencies": [
          "68"
        ],
        "status": "done",
        "subtasks": [],
        "updatedAt": "2026-01-07T19:21:03.406Z"
      },
      {
        "id": "71",
        "title": "Comprehensive Integration Testing and Validation",
        "description": "Perform end-to-end testing to validate all coaching chat consolidation requirements",
        "details": "Execute comprehensive testing covering all success criteria: verify message icons from all locations open the same coaching chat, validate correct tab placement for different user types and enrollment states, test channel naming consistency, ensure no duplicate channels are created, verify channels don't disappear when clicked, and validate unread counts work correctly. Test edge cases including multiple coaches, enrollment changes, and coach-initiated contact scenarios.",
        "testStrategy": "End-to-end testing scenarios for coaches and clients, automated tests for channel creation/retrieval, manual testing of UI interactions, performance testing for channel loading, validation of all success criteria from the PRD",
        "priority": "high",
        "dependencies": [
          "65",
          "66",
          "68",
          "70"
        ],
        "status": "pending",
        "subtasks": []
      }
    ],
    "metadata": {
      "version": "1.0.0",
      "lastModified": "2026-01-07T19:21:03.407Z",
      "taskCount": 12,
      "completedCount": 10,
      "tags": [
        "master"
      ]
    }
  }
}